---
import BaseLayout from '../layouts/BaseLayout.astro';

const sayings = [
  'Fear is the mind-killer. Fear is the little-death that brings total obliteration.',
  'A beginning is a very delicate time.',
  'He who can destroy a thing controls a thing.',
  'The mystery of life is not a problem to solve, but a reality to experience.',
  'Without change, something sleeps inside us, and seldom awakens.',
  'Arrakis teaches the attitude of the knife—chopping off what is incomplete and saying: Now it is complete.'
];

const parties = [
  { name: 'House Sereth Bloc', seats: 31, color: '#d8b26a' },
  { name: 'Imperial Loyalists', seats: 27, color: '#77c9ff' },
  { name: 'CHOAM Compact', seats: 24, color: '#79df9c' },
  { name: 'Frontier Coalition', seats: 18, color: '#f28ea7' }
];

const seatPool = parties.flatMap((party) =>
  Array.from({ length: party.seats }, (_, idx) => ({
    id: `${party.name}-${idx + 1}`,
    party: party.name,
    color: party.color
  }))
);

const senateRows = [14, 18, 22, 22, 24];
const minRadius = 26;
const radiusStep = 8.5;
const startAngle = 165;
const endAngle = 15;

const senateSeats = senateRows.flatMap((rowSeats, rowIndex) => {
  const radius = minRadius + rowIndex * radiusStep;

  return Array.from({ length: rowSeats }, (_, colIndex) => {
    const seat = seatPool.shift();
    const ratio = rowSeats === 1 ? 0.5 : colIndex / (rowSeats - 1);
    const angleDeg = startAngle - (startAngle - endAngle) * ratio;
    const angleRad = (angleDeg * Math.PI) / 180;
    const x = 50 + radius * Math.cos(angleRad);
    const y = 90 - radius * Math.sin(angleRad);

    return {
      ...(seat || { id: `seat-${rowIndex}-${colIndex}`, party: 'Independent', color: '#d8b26a' }),
      x: x.toFixed(2),
      y: y.toFixed(2)
    };
  });
});

const voteActions = ['Spice Reserve Release', 'Border Skirmish Response', 'Guild Passage Tax'];
---

<BaseLayout title="Chronicles of House Xolotal | Dune Ledger">
  <header class="hero">
    <div class="hero__veil"></div>
    <div class="hero__content">
      <p class="eyebrow">Arrakis Campaign Ledger</p>
      <div class="hero__title-row">
        <h1>Chronicles of House Xolotal</h1>
        <div class="sigil" role="img" aria-label="House Xolotal sigil">
          <svg viewBox="0 0 120 140" xmlns="http://www.w3.org/2000/svg">
            <path d="M60 6L108 28V70C108 100 89 122 60 134C31 122 12 100 12 70V28L60 6Z" />
            <path d="M60 25L83 35V69C83 83 74 96 60 104C46 96 37 83 37 69V35L60 25Z" class="inner"/>
            <path d="M60 39C70 47 72 61 64 71C59 77 58 84 60 93C49 84 43 74 44 62C45 51 51 44 60 39Z" class="worm"/>
          </svg>
        </div>
      </div>
      <p>
        From the sands of Arrakis to the halls of the Landsraad, monitor treaties, spice, and intrigue while
        House Xolotal rises beneath the desert moon.
      </p>
    </div>
  </header>

  <main class="layout">
    <section class="card card--wide senate-section">
      <h2>Kontor (100 Seats)</h2>
      <p class="section-intro">Each seat belongs to one of four active factions. Seats are placed in a broad chamber arc.</p>
      <div class="senate-arc" role="img" aria-label="Semicircle senate seating with 100 members">
        {
          senateSeats.map((seat, idx) => (
            <span
              class="senate-seat"
              style={`--x:${seat.x}%; --y:${seat.y}%; --seat-color:${seat.color};`}
              title={`${seat.party} seat ${idx + 1}`}
            ></span>
          ))
        }
      </div>
      <ul class="party-legend">
        {parties.map((party) => (
          <li>
            <span class="party-dot" style={`--party-color:${party.color};`}></span>
            <span>{party.name}</span>
            <strong>{party.seats} seats</strong>
          </li>
        ))}
      </ul>
    </section>

    <section class="card card--wide vote-section">
      <h2>Player Vote Console</h2>
      <p class="section-intro">Players can vote from any computer connected to this server. One vote per player name, per action.</p>
      <label class="vote-label" for="player-name">Player name</label>
      <input id="player-name" class="vote-input" type="text" maxlength="32" placeholder="e.g. Lady Veyra" />
      <div class="vote-grid">
        {voteActions.map((action) => (
          <article class="vote-card" data-action={action}>
            <h3>{action}</h3>
            <p class="vote-tally" data-tally={action}>Support 0 · Oppose 0 · Abstain 0</p>
            <div class="vote-actions">
              <button type="button" data-choice="support">Support</button>
              <button type="button" data-choice="oppose">Oppose</button>
              <button type="button" data-choice="abstain">Abstain</button>
            </div>
          </article>
        ))}
      </div>
      <p id="vote-status" class="fine-print">Loading vote totals…</p>
    </section>

    <section class="card card--wide">
      <h2>Imperial Dispatches</h2>
      <p class="section-intro">Recent whispers carried by ornithopter and courier.</p>
      <ul class="timeline">
        <li><time datetime="10191-04-17">Cycle 10191.04.17</time><p>Fremen scouts confirmed pre-spice mass near the Cielago ridge. House Xolotal claims extraction rights at dawn.</p></li>
        <li><time datetime="10191-04-12">Cycle 10191.04.12</time><p>An imperial observer vessel entered low orbit, forcing every minor house to issue public pledges of loyalty.</p></li>
        <li><time datetime="10191-04-05">Cycle 10191.04.05</time><p>A clandestine CHOAM envoy offered shipping priority in exchange for senate leverage against House Moritani.</p></li>
      </ul>
    </section>

    <section class="card">
      <h2>House Assets</h2>
      <ul class="stat-list">
        <li><span>Solaris Reserve</span><strong>4,200,000</strong></li>
        <li><span>Spice Stockpile</span><strong>1,380 kg</strong></li>
        <li><span>Shield Corps</span><strong>620 retainers</strong></li>
        <li><span>Influence in Landsraad</span><strong>Rising</strong></li>
      </ul>
    </section>

    <section class="card">
      <h2>Great Houses Standing</h2>
      <ol class="standings">
        <li><span>House Corrino</span><strong>92</strong></li>
        <li><span>House Atreides</span><strong>89</strong></li>
        <li><span>House Harkonnen</span><strong>86</strong></li>
        <li><span>House Xolotal</span><strong>74</strong></li>
      </ol>
      <p class="fine-print">Scores represent political favor and vote-weight this cycle.</p>
    </section>
  </main>

  <aside class="daily-saying">
    <h2>Litany of the Day</h2>
    <blockquote id="daily-quote"></blockquote>
    <p class="quote-meta">A quote shifts with the imperial cycle each UTC day.</p>
  </aside>

  <script define:vars={{ sayings }}>
    const today = new Date();
    const daySeed =
      today.getUTCFullYear() * 1000 +
      Math.floor((today - new Date(Date.UTC(today.getUTCFullYear(), 0, 0))) / 86400000);

    const quote = sayings[daySeed % sayings.length];
    const quoteNode = document.getElementById('daily-quote');
    if (quoteNode) quoteNode.textContent = `“${quote}”`;

    const statusNode = document.getElementById('vote-status');
    const inputNode = document.getElementById('player-name');
    const cards = [...document.querySelectorAll('.vote-card')];

    const setStatus = (message) => {
      if (statusNode) statusNode.textContent = message;
    };

    const renderTotals = (totals) => {
      totals.forEach((item) => {
        const tallyNode = document.querySelector(`[data-tally="${item.actionId}"]`);
        if (!tallyNode) return;
        const { support, oppose, abstain } = item.tally;
        tallyNode.textContent = `Support ${support} · Oppose ${oppose} · Abstain ${abstain}`;
      });
    };

    const loadTotals = async () => {
      const response = await fetch('/api/votes.json');
      const payload = await response.json();
      renderTotals(payload.totals || []);
      setStatus('Vote totals synced.');
    };

    cards.forEach((card) => {
      card.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-choice]');
        if (!button) return;

        const player = inputNode?.value?.trim() || '';
        if (!player) {
          setStatus('Set a player name before voting.');
          inputNode?.focus();
          return;
        }

        const actionId = card.dataset.action;
        if (!actionId) return;

        setStatus(`Submitting ${button.dataset.choice} vote on ${actionId}…`);

        const response = await fetch('/api/votes.json', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ actionId, player, choice: button.dataset.choice })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          setStatus(err.error || 'Vote submission failed.');
          return;
        }

        const payload = await response.json();
        renderTotals(payload.totals || []);
        localStorage.setItem('arrakis-player-name', player);
        setStatus(`${player} voted ${button.dataset.choice} on ${actionId}.`);
      });
    });

    const savedPlayer = localStorage.getItem('arrakis-player-name');
    if (savedPlayer && inputNode && !inputNode.value) inputNode.value = savedPlayer;

    loadTotals().catch(() => setStatus('Vote server offline. Start Astro in server mode to collect live votes.'));
  </script>
</BaseLayout>
