---
import BaseLayout from '../layouts/BaseLayout.astro';
import sessions from '../data/sessions.json';
import sayings from '../data/sayings.json';
import parties from '../data/senate-parties.json';
import voteActions from '../data/vote-actions.json';
import briefings from '../data/house-minor-briefings.json';
import settlements from '../data/settlements.json';
import powerStandings from '../data/power-standings.json';
import notableCharacters from '../data/notable-characters.json';
import ruler from '../data/ruler.json';

const seatPool = parties.flatMap((party) =>
  Array.from({ length: party.seats }, (_, idx) => ({
    id: `${party.name}-${idx + 1}`,
    party: party.name,
    color: party.color
  }))
);

const senateRows = [14, 18, 22, 22, 24];
const minRadius = 22;
const radiusStep = 6;
const startAngle = 165;
const endAngle = 15;

const senateSeats = senateRows.flatMap((rowSeats, rowIndex) => {
  const radius = minRadius + rowIndex * radiusStep;

  return Array.from({ length: rowSeats }, (_, colIndex) => {
    const seat = seatPool.shift();
    const ratio = rowSeats === 1 ? 0.5 : colIndex / (rowSeats - 1);
    const angleDeg = startAngle - (startAngle - endAngle) * ratio;
    const angleRad = (angleDeg * Math.PI) / 180;
    const x = 50 + radius * Math.cos(angleRad);
    const y = 90 - radius * Math.sin(angleRad);

    return {
      ...(seat || { id: `seat-${rowIndex}-${colIndex}`, party: 'Bagimsiz', color: '#d8b26a' }),
      x: x.toFixed(2),
      y: y.toFixed(2)
    };
  });
});

const allowedPlayers = ['Lakin', 'Tenok', 'Faruk'];
const firebaseBaseUrl = 'https://xolotal-default-rtdb.europe-west1.firebasedatabase.app';
const orderedSessions = [...sessions].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
const imageBaseUrl = 'https://dogukannn.github.io/xolotal';
const resolveImageUrl = (url) => (url?.startsWith('/images/') ? `${imageBaseUrl}${url}` : url);
---

<BaseLayout title="Xolotan Hanesi | Trisk Kayitlari">
  <header class="hero">
    <div class="hero__veil"></div>
    <div class="hero__content">
      <p class="eyebrow">Trisk Saray Kayitlari</p>
      <div class="hero__title-row">
        <h1>Xolotan Hanesi</h1>
        <aside class="ruler-card">
          <img src={resolveImageUrl(ruler.portraitUrl)} alt={ruler.portraitAlt} width={ruler.width} height={ruler.height} loading="lazy" />
          <div>
            <p class="fine-print">Current Ruler</p>
            <strong>{ruler.name}</strong>
            <p>{ruler.title}</p>
          </div>
        </aside>
        <div class="sigil" role="img" aria-label="Xolotan Hanesi arması">
          <svg viewBox="0 0 120 140" xmlns="http://www.w3.org/2000/svg">
            <path d="M60 6L108 28V70C108 100 89 122 60 134C31 122 12 100 12 70V28L60 6Z" />
            <path d="M60 25L83 35V69C83 83 74 96 60 104C46 96 37 83 37 69V35L60 25Z" class="inner"/>
            <path d="M60 39C70 47 72 61 64 71C59 77 58 84 60 93C49 84 43 74 44 62C45 51 51 44 60 39Z" class="worm"/>
          </svg>
        </div>
      </div>
      <p>
        Gezegen Trisk, dunya benzeri ama ekstra biyocesitlilige sahip bir duzen kurdu. Saray, jungle benzeri
        bir ormanin ortasinda; etrafi hayvan ciftlikleriyle cevrili. Yerel halk hayvanlarla icli disli yasarken,
        hane trait’i kusursuzluk olarak bilinir.
      </p>
    </div>
  </header>

  <aside class="daily-saying">
    <h2>Gunluk Söz</h2>
    <blockquote id="daily-quote"></blockquote>
    <p class="quote-meta">Her UTC gununde Trisk’in soylu kayitlarindan yeni bir soz gelir.</p>
  </aside>

  <main class="layout">
    <section class="card card--wide senate-section">
      <h2>Kontor (100 Koltuk)</h2>
      <p class="section-intro">Monarsi ve senato carpismasi devam ederken isyanci gruplar dengeyi zorluyor.</p>
      <div class="senate-arc" role="img" aria-label="Trisk senato dagilimi">
        {
          senateSeats.map((seat, idx) => (
            <span
              class="senate-seat"
              style={`--x:${seat.x}%; --y:${seat.y}%; --seat-color:${seat.color};`}
              title={`${seat.party} koltuk ${idx + 1}`}
            ></span>
          ))
        }
      </div>
      <ul class="party-legend">
        {parties.map((party) => (
          <li>
            <span class="party-dot" style={`--party-color:${party.color};`}></span>
            <span>{party.name}</span>
            <strong>{party.seats} koltuk</strong>
          </li>
        ))}
      </ul>
    </section>

    <section class="card card--wide vote-section">
      <h2>Oy Konsolu (Toplam 3 Oycu)</h2>
      <p class="section-intro">Sadece Lakin, Tenok ve Faruk oy verebilir. Bu uc isim disindaki oylar gonderilmez.</p>
      <label class="vote-label" for="player-name">Oyuncu adi</label>
      <input id="player-name" class="vote-input" type="text" maxlength="32" placeholder="Lakin / Tenok / Faruk" />
      <div class="vote-grid">
        {voteActions.map((action) => (
          <article class="vote-card" data-action={action}>
            <h3>{action}</h3>
            <p class="vote-tally" data-tally={action}>Support 0 · Oppose 0 · Abstain 0</p>
            <div class="vote-actions">
              <button type="button" data-choice="support">Support</button>
              <button type="button" data-choice="oppose">Oppose</button>
              <button type="button" data-choice="abstain">Abstain</button>
            </div>
          </article>
        ))}
      </div>
      <p id="vote-status" class="fine-print">Oylar yukleniyor…</p>
      <p id="prophecy-event" class="fine-print" hidden>
        Etkinlik tetiklendi: Lakin, Tenok ve Faruk oy verdi. Buyuk yaratik gelip herkesi kurtaracak kehaneti aktif.
      </p>
    </section>

    <section class="card card--wide">
      <h2>House Minor Brifingi</h2>
      <ul class="timeline">
        {briefings.map((entry) => (
          <li>
            <time datetime={entry.date}>{entry.date.replaceAll('-', '.')}</time>
            <p>{entry.note}</p>
          </li>
        ))}
      </ul>
    </section>

    <section class="card card--wide">
      <h2>Session Arsivi</h2>
      <p class="section-intro">Her oturumda tehdit puani, momentum, determination puani ve spotlight notlarini takip edin.</p>
      <div class="session-grid">
        {orderedSessions.map((session) => (
          <article class="session-card">
            <header>
              <h3>{session.title}</h3>
              <p class="fine-print">{session.date}</p>
            </header>
            <dl class="session-metrics">
              <div>
                <dt>Threat Points</dt>
                <dd>{session.threatPoints}</dd>
              </div>
              <div>
                <dt>Momentum</dt>
                <dd>{session.momentum}</dd>
              </div>
              <div>
                <dt>Determination</dt>
                <dd>{session.determinationPoints}</dd>
              </div>
            </dl>
            <h4>Session Spotlights</h4>
            <ul class="session-spotlights">
              {session.spotlights.map((spotlight) => (
                <li>{spotlight}</li>
              ))}
            </ul>
            {session.notes && <p class="fine-print">Not: {session.notes}</p>}
          </article>
        ))}
      </div>
    </section>

    <section class="card">
      <h2>Trisk Yerlesimleri</h2>
      <ul class="stat-list">
        {settlements.map((item) => (
          <li><span>{item.label}</span><strong>{item.value}</strong></li>
        ))}
      </ul>
    </section>

    <section class="card">
      <h2>Guc Dengesi ve Kisiler</h2>
      <ol class="standings">
        {powerStandings.standings.map((item) => (
          <li><span>{item.name}</span><strong>{item.title}</strong></li>
        ))}
      </ol>
      <p class="fine-print">Rivaller: {powerStandings.rivals}. Resmi kiyafet: {powerStandings.uniform}.</p>
    </section>

    <section class="card card--wide">
      <h2>Deneysel Portre Galerisi</h2>
      <p class="section-intro">Notable karakterleri portreleriyle takip edin; olay bazli notlar icin JSON kaydini guncelleyin.</p>
      <div class="portrait-grid">
        {notableCharacters.map((character) => (
          <article class="portrait-card">
            <img
              src={resolveImageUrl(character.portraitUrl)}
              alt={character.portraitAlt}
              width={character.width}
              height={character.height}
              loading="lazy"
            />
            <h3>{character.name}</h3>
            <p class="fine-print">{character.title}</p>
            {character.notes && <p>{character.notes}</p>}
          </article>
        ))}
      </div>
    </section>
  </main>


  <script define:vars={{ sayings, voteActions, firebaseBaseUrl, allowedPlayers }}>
    const today = new Date();
    const daySeed =
      today.getUTCFullYear() * 1000 +
      Math.floor((today - new Date(Date.UTC(today.getUTCFullYear(), 0, 0))) / 86400000);

    const quote = sayings[daySeed % sayings.length];
    const quoteNode = document.getElementById('daily-quote');
    if (quoteNode) quoteNode.textContent = `“${quote}”`;

    const statusNode = document.getElementById('vote-status');
    const eventNode = document.getElementById('prophecy-event');
    const firebaseVotesEndpoint = `${firebaseBaseUrl}/votes.json`;
    const inputNode = document.getElementById('player-name');
    const cards = [...document.querySelectorAll('.vote-card')];

    const normalize = (name) => name.trim().toLowerCase();

    const canonicalPlayer = (name) => {
      const normalized = normalize(name);
      return allowedPlayers.find((candidate) => normalize(candidate) === normalized) || null;
    };

    const setStatus = (message) => {
      if (statusNode) statusNode.textContent = message;
    };

    const summarize = (votes) => {
      return voteActions.map((actionId) => {
        const tally = { support: 0, oppose: 0, abstain: 0 };
        votes
          .filter((vote) => vote.actionId === actionId)
          .forEach((vote) => {
            if (vote.choice in tally) tally[vote.choice] += 1;
          });

        return { actionId, tally };
      });
    };

    const renderTotals = (totals) => {
      totals.forEach((item) => {
        const tallyNode = document.querySelector(`[data-tally="${item.actionId}"]`);
        if (!tallyNode) return;
        const { support, oppose, abstain } = item.tally;
        tallyNode.textContent = `Support ${support} · Oppose ${oppose} · Abstain ${abstain}`;
      });
    };

    const updateEventState = (votes) => {
      const voters = new Set(votes.map((vote) => canonicalPlayer(vote.player)).filter(Boolean));
      const triggered = allowedPlayers.every((player) => voters.has(player));
      if (eventNode) eventNode.hidden = !triggered;
      return triggered;
    };

    const loadVotes = async () => {
      const response = await fetch(firebaseVotesEndpoint);
      const payload = await response.json();
      if (!response.ok) throw new Error('Failed to load votes');
      if (!payload || typeof payload !== 'object') return [];
      return Object.values(payload).filter((vote) => canonicalPlayer(vote.player));
    };

    const saveVote = async (entry) => {
      const voteKey = `${entry.actionId.toLowerCase().replace(/[^a-z0-9]+/g, '-')}_${entry.player
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')}`;

      const response = await fetch(`${firebaseBaseUrl}/votes/${voteKey}.json`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry)
      });

      if (!response.ok) throw new Error('Could not save vote.');
    };

    const loadTotals = async () => {
      const votes = await loadVotes();
      renderTotals(summarize(votes));
      const triggered = updateEventState(votes);
      setStatus(triggered ? 'Uc oyuncu da oy verdi, etkinlik acildi.' : 'Oy toplamları senkronize edildi.');
    };

    cards.forEach((card) => {
      card.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-choice]');
        if (!button) return;

        const playerInput = inputNode?.value?.trim() || '';
        if (!playerInput) {
          setStatus('Oy vermeden once oyuncu adi girin.');
          inputNode?.focus();
          return;
        }

        const player = canonicalPlayer(playerInput);
        if (!player) {
          setStatus('Sadece Lakin, Tenok ve Faruk oy verebilir.');
          return;
        }

        const actionId = card.dataset.action;
        if (!actionId) return;

        setStatus(`${player} icin oy gonderiliyor…`);

        try {
          await saveVote({
            actionId,
            player,
            choice: button.dataset.choice,
            updatedAt: new Date().toISOString()
          });
          await loadTotals();
          localStorage.setItem('trisk-player-name', player);
          setStatus(`${player}, ${actionId} icin ${button.dataset.choice} oyu verdi.`);
        } catch {
          setStatus('Oy gonderimi basarisiz.');
        }
      });
    });

    const savedPlayer = localStorage.getItem('trisk-player-name');
    if (savedPlayer && inputNode && !inputNode.value) inputNode.value = savedPlayer;

    loadTotals().catch(() => setStatus('Oy sunucusuna ulasilamadi. Firebase/CORS kontrol edin.'));
  </script>
</BaseLayout>
