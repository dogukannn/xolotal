---
import BaseLayout from '../layouts/BaseLayout.astro';

const sayings = [
  'Trisk’te yasam, avlanilan canliya degil onu buyutene saygiyla olculur.',
  'Kusursuz olan hayatta kalir; sadik olan yonetir.',
  'Broodmother’ın sesi, saray ormaninin tum ciftliklerinde yankilanir.',
  'Biyocesitlilik bolluk getirir ama esitlik getirmez.',
  'Senato ile monarsi catistiginda halk isyanin adini koyar.'
];

const parties = [
  { name: 'Monarsi Yanlilari', seats: 36, color: '#d8b26a' },
  { name: 'Senato Bloku', seats: 28, color: '#77c9ff' },
  { name: 'Isyanci Grup', seats: 22, color: '#79df9c' },
  { name: 'Anerkil Konfederasyon', seats: 14, color: '#f28ea7' }
];

const seatPool = parties.flatMap((party) =>
  Array.from({ length: party.seats }, (_, idx) => ({
    id: `${party.name}-${idx + 1}`,
    party: party.name,
    color: party.color
  }))
);

const senateRows = [14, 18, 22, 22, 24];
const minRadius = 22;
const radiusStep = 6;
const startAngle = 165;
const endAngle = 15;

const senateSeats = senateRows.flatMap((rowSeats, rowIndex) => {
  const radius = minRadius + rowIndex * radiusStep;

  return Array.from({ length: rowSeats }, (_, colIndex) => {
    const seat = seatPool.shift();
    const ratio = rowSeats === 1 ? 0.5 : colIndex / (rowSeats - 1);
    const angleDeg = startAngle - (startAngle - endAngle) * ratio;
    const angleRad = (angleDeg * Math.PI) / 180;
    const x = 50 + radius * Math.cos(angleRad);
    const y = 90 - radius * Math.sin(angleRad);

    return {
      ...(seat || { id: `seat-${rowIndex}-${colIndex}`, party: 'Bagimsiz', color: '#d8b26a' }),
      x: x.toFixed(2),
      y: y.toFixed(2)
    };
  });
});

const voteActions = ['House Minor Yetki Oyu', '3 Tehdit Noktasi Savunmasi', 'Kurtarici Yaratik Kehaneti'];
const allowedPlayers = ['Lakin', 'Tenok', 'Faruk'];
const firebaseBaseUrl = 'https://xolotal-default-rtdb.europe-west1.firebasedatabase.app';
---

<BaseLayout title="Zolotan Hanesi | Trisk Kayitlari">
  <header class="hero">
    <div class="hero__veil"></div>
    <div class="hero__content">
      <p class="eyebrow">Trisk Saray Kayitlari</p>
      <div class="hero__title-row">
        <h1>Zolotan Hanesi</h1>
        <div class="sigil" role="img" aria-label="Zolotan Hanesi arması">
          <svg viewBox="0 0 120 140" xmlns="http://www.w3.org/2000/svg">
            <path d="M60 6L108 28V70C108 100 89 122 60 134C31 122 12 100 12 70V28L60 6Z" />
            <path d="M60 25L83 35V69C83 83 74 96 60 104C46 96 37 83 37 69V35L60 25Z" class="inner"/>
            <path d="M60 39C70 47 72 61 64 71C59 77 58 84 60 93C49 84 43 74 44 62C45 51 51 44 60 39Z" class="worm"/>
          </svg>
        </div>
      </div>
      <p>
        Gezegen Trisk, dunya benzeri ama ekstra biyocesitlilige sahip bir duzen kurdu. Saray, jungle benzeri
        bir ormanin ortasinda; etrafi hayvan ciftlikleriyle cevrili. Yerel halk hayvanlarla icli disli yasarken,
        hane trait’i kusursuzluk olarak bilinir.
      </p>
    </div>
  </header>

  <aside class="daily-saying">
    <h2>Gunluk Söz</h2>
    <blockquote id="daily-quote"></blockquote>
    <p class="quote-meta">Her UTC gununde Trisk’in soylu kayitlarindan yeni bir soz gelir.</p>
  </aside>

  <main class="layout">
    <section class="card card--wide senate-section">
      <h2>Kontor (100 Koltuk)</h2>
      <p class="section-intro">Monarsi ve senato carpismasi devam ederken isyanci gruplar dengeyi zorluyor.</p>
      <div class="senate-arc" role="img" aria-label="Trisk senato dagilimi">
        {
          senateSeats.map((seat, idx) => (
            <span
              class="senate-seat"
              style={`--x:${seat.x}%; --y:${seat.y}%; --seat-color:${seat.color};`}
              title={`${seat.party} koltuk ${idx + 1}`}
            ></span>
          ))
        }
      </div>
      <ul class="party-legend">
        {parties.map((party) => (
          <li>
            <span class="party-dot" style={`--party-color:${party.color};`}></span>
            <span>{party.name}</span>
            <strong>{party.seats} koltuk</strong>
          </li>
        ))}
      </ul>
    </section>

    <section class="card card--wide vote-section">
      <h2>Oy Konsolu (Toplam 3 Oycu)</h2>
      <p class="section-intro">Sadece Lakin, Tenok ve Faruk oy verebilir. Bu uc isim disindaki oylar gonderilmez.</p>
      <label class="vote-label" for="player-name">Oyuncu adi</label>
      <input id="player-name" class="vote-input" type="text" maxlength="32" placeholder="Lakin / Tenok / Faruk" />
      <div class="vote-grid">
        {voteActions.map((action) => (
          <article class="vote-card" data-action={action}>
            <h3>{action}</h3>
            <p class="vote-tally" data-tally={action}>Support 0 · Oppose 0 · Abstain 0</p>
            <div class="vote-actions">
              <button type="button" data-choice="support">Support</button>
              <button type="button" data-choice="oppose">Oppose</button>
              <button type="button" data-choice="abstain">Abstain</button>
            </div>
          </article>
        ))}
      </div>
      <p id="vote-status" class="fine-print">Oylar yukleniyor…</p>
      <p id="prophecy-event" class="fine-print" hidden>
        Etkinlik tetiklendi: Lakin, Tenok ve Faruk oy verdi. Buyuk yaratik gelip herkesi kurtaracak kehaneti aktif.
      </p>
    </section>

    <section class="card card--wide">
      <h2>House Minor Brifingi</h2>
      <ul class="timeline">
        <li><time datetime="10201-01-03">10201.01.03</time><p>Major tehdit: hayvan genetigi degistirip satmaca agi Trisk genelinde karaborsa yaratti.</p></li>
        <li><time datetime="10201-01-05">10201.01.05</time><p>Minor tehdit: din satiliyor, titanlarin evrenin sonu olacagina inanc pazarlaniyor.</p></li>
        <li><time datetime="10201-01-07">10201.01.07</time><p>3 tehdit noktasi icin senato acil oylamaya gitti; monarsi ile gerilim artti.</p></li>
      </ul>
    </section>

    <section class="card">
      <h2>Trisk Yerlesimleri</h2>
      <ul class="stat-list">
        <li><span>Milyonluk Sehir I</span><strong>Ankara Nova</strong></li>
        <li><span>Milyonluk Sehir II</span><strong>Istanbur Prime</strong></li>
        <li><span>Milyonluk Sehir III</span><strong>Izmir Delta</strong></li>
        <li><span>Ada Yerlesimi</span><strong>Serit Ada</strong></li>
      </ul>
    </section>

    <section class="card">
      <h2>Guc Dengesi ve Kisiler</h2>
      <ol class="standings">
        <li><span>Kralice 4. Serena</span><strong>Dogu yurtlarinin fatihi</strong></li>
        <li><span>Patron Jinping</span><strong>Cip adami cinli</strong></li>
        <li><span>Yusa "Lakin"</span><strong>Suk dropoutu</strong></li>
        <li><span>Eray "Tenok"</span><strong>Dinci</strong></li>
        <li><span>Yusuf "Faruk Naib"</span><strong>Fremen gorusu</strong></li>
      </ol>
      <p class="fine-print">Rivaller: Loathing ve Servitude. Resmi kiyafet: Hun pazarlama AS renkleri.</p>
    </section>
  </main>


  <script define:vars={{ sayings, voteActions, firebaseBaseUrl, allowedPlayers }}>
    const today = new Date();
    const daySeed =
      today.getUTCFullYear() * 1000 +
      Math.floor((today - new Date(Date.UTC(today.getUTCFullYear(), 0, 0))) / 86400000);

    const quote = sayings[daySeed % sayings.length];
    const quoteNode = document.getElementById('daily-quote');
    if (quoteNode) quoteNode.textContent = `“${quote}”`;

    const statusNode = document.getElementById('vote-status');
    const eventNode = document.getElementById('prophecy-event');
    const firebaseVotesEndpoint = `${firebaseBaseUrl}/votes.json`;
    const inputNode = document.getElementById('player-name');
    const cards = [...document.querySelectorAll('.vote-card')];

    const normalize = (name) => name.trim().toLowerCase();

    const canonicalPlayer = (name) => {
      const normalized = normalize(name);
      return allowedPlayers.find((candidate) => normalize(candidate) === normalized) || null;
    };

    const setStatus = (message) => {
      if (statusNode) statusNode.textContent = message;
    };

    const summarize = (votes) => {
      return voteActions.map((actionId) => {
        const tally = { support: 0, oppose: 0, abstain: 0 };
        votes
          .filter((vote) => vote.actionId === actionId)
          .forEach((vote) => {
            if (vote.choice in tally) tally[vote.choice] += 1;
          });

        return { actionId, tally };
      });
    };

    const renderTotals = (totals) => {
      totals.forEach((item) => {
        const tallyNode = document.querySelector(`[data-tally="${item.actionId}"]`);
        if (!tallyNode) return;
        const { support, oppose, abstain } = item.tally;
        tallyNode.textContent = `Support ${support} · Oppose ${oppose} · Abstain ${abstain}`;
      });
    };

    const updateEventState = (votes) => {
      const voters = new Set(votes.map((vote) => canonicalPlayer(vote.player)).filter(Boolean));
      const triggered = allowedPlayers.every((player) => voters.has(player));
      if (eventNode) eventNode.hidden = !triggered;
      return triggered;
    };

    const loadVotes = async () => {
      const response = await fetch(firebaseVotesEndpoint);
      const payload = await response.json();
      if (!response.ok) throw new Error('Failed to load votes');
      if (!payload || typeof payload !== 'object') return [];
      return Object.values(payload).filter((vote) => canonicalPlayer(vote.player));
    };

    const saveVote = async (entry) => {
      const voteKey = `${entry.actionId.toLowerCase().replace(/[^a-z0-9]+/g, '-')}_${entry.player
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')}`;

      const response = await fetch(`${firebaseBaseUrl}/votes/${voteKey}.json`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry)
      });

      if (!response.ok) throw new Error('Could not save vote.');
    };

    const loadTotals = async () => {
      const votes = await loadVotes();
      renderTotals(summarize(votes));
      const triggered = updateEventState(votes);
      setStatus(triggered ? 'Uc oyuncu da oy verdi, etkinlik acildi.' : 'Oy toplamları senkronize edildi.');
    };

    cards.forEach((card) => {
      card.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-choice]');
        if (!button) return;

        const playerInput = inputNode?.value?.trim() || '';
        if (!playerInput) {
          setStatus('Oy vermeden once oyuncu adi girin.');
          inputNode?.focus();
          return;
        }

        const player = canonicalPlayer(playerInput);
        if (!player) {
          setStatus('Sadece Lakin, Tenok ve Faruk oy verebilir.');
          return;
        }

        const actionId = card.dataset.action;
        if (!actionId) return;

        setStatus(`${player} icin oy gonderiliyor…`);

        try {
          await saveVote({
            actionId,
            player,
            choice: button.dataset.choice,
            updatedAt: new Date().toISOString()
          });
          await loadTotals();
          localStorage.setItem('trisk-player-name', player);
          setStatus(`${player}, ${actionId} icin ${button.dataset.choice} oyu verdi.`);
        } catch {
          setStatus('Oy gonderimi basarisiz.');
        }
      });
    });

    const savedPlayer = localStorage.getItem('trisk-player-name');
    if (savedPlayer && inputNode && !inputNode.value) inputNode.value = savedPlayer;

    loadTotals().catch(() => setStatus('Oy sunucusuna ulasilamadi. Firebase/CORS kontrol edin.'));
  </script>
</BaseLayout>
